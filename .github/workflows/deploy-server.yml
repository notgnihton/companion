name: Deploy Server

on:
  push:
    branches:
      - main
    paths:
      - 'apps/server/**'
      - '.github/workflows/deploy-server.yml'
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: 'apps/server/package-lock.json'
      
      - name: Install dependencies
        working-directory: apps/server
        run: npm ci
      
      - name: Type check
        working-directory: apps/server
        run: npm run typecheck
      
      - name: Run tests
        working-directory: apps/server
        run: npm test

  build:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        working-directory: apps/server
        run: |
          docker build -t companion-server:latest .
      
      - name: Test Docker health check
        run: |
          docker run -d --name test-server -p 8787:8787 \
            -e AXIS_TIMEZONE=America/New_York \
            -e AXIS_USER_NAME=TestUser \
            -e GEMINI_API_KEY=test \
            companion-server:latest
          
          # Wait for server to start
          sleep 5
          
          # Check health endpoint
          curl -f http://localhost:8787/api/health || exit 1
          
          # Cleanup
          docker stop test-server
          docker rm test-server

  # Railway deployment happens automatically via Railway GitHub integration
  # No explicit deploy step needed — Railway detects changes in apps/server/ and deploys
  notify:
    runs-on: ubuntu-latest
    needs: [test, build]
    if: success()
    steps:
      - name: Deployment ready
        run: |
          echo "✅ Server tests passed and Docker build succeeded"
          echo "Railway will auto-deploy from main branch if connected"
