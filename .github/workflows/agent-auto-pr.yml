name: Auto-create Agent PR

on:
  push:
    branches:
      - 'agent/**'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract issue number from branch name
        id: extract
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          # Extract issue number from branch name (e.g., agent/123-description -> 123)
          ISSUE_NUM=$(echo "$BRANCH_NAME" | sed -n 's/^agent\/\([0-9]\+\)-.*/\1/p')
          echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT
          
          # Create PR title from branch name
          TITLE=$(echo "$BRANCH_NAME" | sed 's/^agent\/[0-9]\+-//' | sed 's/-/ /g' | sed 's/\b\(.\)/\u\1/g')
          echo "title=[Agent Task] $TITLE" >> $GITHUB_OUTPUT

      - name: Check if PR already exists and create if needed
        id: check-pr
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ steps.extract.outputs.branch }}';
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // Check for existing PR
            const { data: pullRequests } = await github.rest.pulls.list({
              owner,
              repo,
              head: `${owner}:${branchName}`,
              state: 'open'
            });
            
            if (pullRequests.length > 0) {
              core.info(`PR already exists: ${pullRequests[0].html_url}`);
              core.setOutput('exists', 'true');
              core.setOutput('pr_url', pullRequests[0].html_url);
              core.setOutput('pr_number', pullRequests[0].number);
              return;
            }
            
            core.setOutput('exists', 'false');

      - name: Read PR template
        id: template
        if: steps.check-pr.outputs.exists == 'false'
        run: |
          if [ -f ".github/PULL_REQUEST_TEMPLATE.md" ]; then
            TEMPLATE_CONTENT=$(cat .github/PULL_REQUEST_TEMPLATE.md)
          else
            TEMPLATE_CONTENT="## Agent PR Summary
          - Issue: Closes #${{ steps.extract.outputs.issue_number }}
          - Track: (specify A/B/C/D)
          - Agent: github-copilot / codex / pair
          
          ## Validation
          - [ ] Required checks passed
          - [ ] Rebased on latest \`main\` (automation also enforces this)
          - [ ] No unresolved conflicts with parallel tracks
          
          ## Auto-merge
          - [ ] Add label \`agent-automerge\` to allow automatic merge after checks + approval.
          
          ## Integration notes
          - Dependencies handled:
          - Conflict surface reviewed:
          - Follow-up tasks:"
          fi
          
          # Replace placeholder issue number if template has one
          if [ -n "${{ steps.extract.outputs.issue_number }}" ]; then
            TEMPLATE_CONTENT=$(echo "$TEMPLATE_CONTENT" | sed "s/<issue-number>/${{ steps.extract.outputs.issue_number }}/g")
          fi
          
          # Write to file to preserve multiline
          echo "$TEMPLATE_CONTENT" > /tmp/pr-body.md

      - name: Get commit message for body enhancement
        id: commit
        if: steps.check-pr.outputs.exists == 'false'
        run: |
          LAST_COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$LAST_COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        id: create-pr
        if: steps.check-pr.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('/tmp/pr-body.md', 'utf8');
            
            // Get commit message safely
            const commitMsg = process.env.COMMIT_MESSAGE || '';
            
            // Enhance body with commit message if it contains useful info
            let enhancedBody = body;
            if (commitMsg.includes('Verification:')) {
              enhancedBody = body + '\n\n---\n\n## Latest Commit\n' + commitMsg;
            }
            
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '${{ steps.extract.outputs.title }}',
              body: enhancedBody,
              head: '${{ steps.extract.outputs.branch }}',
              base: 'main'
            });
            
            core.setOutput('pr_url', pr.html_url);
            core.setOutput('pr_number', pr.number);
            core.info('âœ… Pull request created: ' + pr.html_url);
            
            // Add agent-task label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['agent-task']
            });
            
            // Add agent-automerge label if commit message contains [automerge]
            if (commitMsg.includes('[automerge]')) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['agent-automerge']
              });
              core.info('âœ… Added agent-automerge label based on commit message');
            }
            
            return pr;
        env:
          COMMIT_MESSAGE: ${{ steps.commit.outputs.message }}

      - name: Comment on linked issue
        if: steps.check-pr.outputs.exists == 'false' && steps.extract.outputs.issue_number != ''
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const issueNumber = parseInt('${{ steps.extract.outputs.issue_number }}');
            if (isNaN(issueNumber)) return;
            
            const prUrl = '${{ steps.create-pr.outputs.pr_url }}';
            const branchName = '${{ steps.extract.outputs.branch }}';
            
            const commentBody = [
              'ðŸ¤– Automated PR created: ' + prUrl,
              '',
              'This PR was automatically generated from branch `' + branchName + '`.',
              '',
              'The agent PR automation workflow will now:',
              '- âœ“ Auto-rebase onto latest `main`',
              '- âœ“ Auto-approve via `github-actions[bot]`',
              '- âœ“ Enable auto-merge if `agent-automerge` label is present',
              '',
              'Status: `in-progress` â†’ `ready-for-review`'
            ].join('\n');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: commentBody
            });

      - name: Summary
        if: steps.check-pr.outputs.exists == 'false'
        run: |
          echo "## ðŸš€ Agent PR Auto-created!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ steps.extract.outputs.branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Title:** ${{ steps.extract.outputs.title }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Issue:** #${{ steps.extract.outputs.issue_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PR:** ${{ steps.create-pr.outputs.pr_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The PR automation workflow will handle rebase, approval, and merge." >> $GITHUB_STEP_SUMMARY

      - name: Skip - PR already exists
        if: steps.check-pr.outputs.exists == 'true'
        run: |
          echo "â„¹ï¸ Pull request already exists for branch ${{ steps.extract.outputs.branch }}"
          echo "## â„¹ï¸ PR Already Exists" >> $GITHUB_STEP_SUMMARY
          echo "A pull request already exists for this branch. No action taken." >> $GITHUB_STEP_SUMMARY
