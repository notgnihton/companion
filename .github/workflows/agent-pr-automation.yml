name: Agent PR Automation

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review, labeled]
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-rebase:
    if: contains(github.event.pull_request.labels.*.name, 'agent-task')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
          token: ${{ secrets.AGENT_PAT || secrets.GITHUB_TOKEN }}

      - name: Rebase onto main
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main

          # Try rebase; on conflict, accept main's version and continue
          if ! git rebase origin/main; then
            echo "Rebase conflict detected — resolving automatically"
            while true; do
              # Remove files deleted on main
              for f in $(git diff --name-only --diff-filter=U); do
                if ! git show origin/main:"$f" > /dev/null 2>&1; then
                  echo "  Removing $f (deleted on main)"
                  git rm "$f"
                else
                  echo "  Accepting main version of $f"
                  git checkout origin/main -- "$f"
                  git add "$f"
                fi
              done
              # Continue rebase; break if done or no more conflicts
              if git rebase --continue --no-edit 2>/dev/null; then
                break
              fi
            done
          fi

          git push --force-with-lease origin ${{ github.event.pull_request.head.ref }}

  auto-merge:
    if: contains(github.event.pull_request.labels.*.name, 'agent-task') && contains(github.event.pull_request.labels.*.name, 'agent-automerge')
    runs-on: ubuntu-latest
    needs: auto-rebase
    steps:
      - name: Merge PR directly
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AGENT_PAT || secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            core.info(`Merging PR #${pr.number} (${pr.title})...`);
            
            try {
              const result = await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                merge_method: 'squash',
                commit_title: pr.title,
                commit_message: `${pr.body}\n\nAuto-merged by agent automation workflow.`
              });
              
              core.info(`✅ PR #${pr.number} merged successfully`);
              core.info(`Merge SHA: ${result.data.sha}`);
              core.info(`Merged: ${result.data.merged}`);
            } catch (error) {
              core.error(`Failed to merge PR: ${error.message}`);
              
              // Add comment explaining the failure
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `⚠️ **Automatic merge failed**: ${error.message}\n\nPlease merge manually.`
              });
              
              throw error;
            }
