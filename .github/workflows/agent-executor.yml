name: Agent Executor

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to work on'
        required: true
        type: string
      issue_title:
        description: 'Issue title'
        required: true
        type: string

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  execute-task:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.AGENT_PAT }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Mark issue as in-progress
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.issue_number }},
              labels: ['in-progress']
            });
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.issue_number }},
              body: 'ü§ñ Agent executor started working on this issue.\n\nWorkflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
            });

      - name: Fetch issue details
        id: issue
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.issue_number }}
            });
            
            core.setOutput('body', issue.body || '');
            core.setOutput('title', issue.title);
            
            // Extract scope and deliverable from issue body
            const body = issue.body || '';
            const scopeMatch = body.match(/## Scope\s+([\s\S]*?)(?=\n##|\n---|\n$)/i);
            const deliverableMatch = body.match(/## Deliverable\s+([\s\S]*?)(?=\n##|\n---|\n$)/i);
            
            core.setOutput('scope', scopeMatch ? scopeMatch[1].trim() : '');
            core.setOutput('deliverable', deliverableMatch ? deliverableMatch[1].trim() : '');

      - name: Create working branch
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          BRANCH_NAME="agent/${{ inputs.issue_number }}-$(echo '${{ inputs.issue_title }}' | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]' | cut -c1-50)"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          
          git checkout -b "$BRANCH_NAME"

      - name: Install dependencies
        run: |
          npm install
          
      - name: Install Codex CLI
        run: |
          npm install -g @openai/codex || echo "Codex CLI install failed, will use fallback"

      - name: Setup GitHub Copilot CLI
        run: |
          gh extension install github/gh-copilot 2>/dev/null || echo "GitHub Copilot CLI already installed or unavailable"
        env:
          GH_TOKEN: ${{ secrets.AGENT_PAT }}

      - name: Execute agent logic
        env:
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          ISSUE_TITLE: ${{ inputs.issue_title }}
          ISSUE_BODY: ${{ steps.issue.outputs.body }}
          ISSUE_SCOPE: ${{ steps.issue.outputs.scope }}
          ISSUE_DELIVERABLE: ${{ steps.issue.outputs.deliverable }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GH_TOKEN: ${{ secrets.AGENT_PAT }}
          GITHUB_TOKEN: ${{ secrets.AGENT_PAT }}
        run: |
          node .github/scripts/agent-executor.js

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet && git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes generated by agent"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git status
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git add -A
          git commit -m "[Agent Task] ${{ inputs.issue_title }} [automerge]

          Closes #${{ inputs.issue_number }}
          
          Automated changes by agent executor."
          
          git push -u origin "$BRANCH_NAME"

      - name: Update issue on success
        if: steps.changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.issue_number }},
              body: '‚úÖ Agent completed work and created PR. Changes will be auto-merged if checks pass.'
            });
            
            // Remove in-progress label
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ inputs.issue_number }},
                name: 'in-progress'
              });
            } catch (e) {
              // Label might not exist, ignore
            }

      - name: Handle no changes case
        if: steps.changes.outputs.has_changes == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.issue_number }},
              body: '‚ö†Ô∏è Agent could not generate changes for this issue. Manual intervention may be required.'
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.issue_number }},
              labels: ['needs-manual-work']
            });
            
            // Remove in-progress label
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ inputs.issue_number }},
                name: 'in-progress'
              });
            } catch (e) {
              // Label might not exist, ignore
            }

      - name: Handle failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.issue_number }},
              body: '‚ùå Agent execution failed. Check workflow logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
            });
            
            // Remove in-progress label and add blocked
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ inputs.issue_number }},
                name: 'in-progress'
              });
            } catch (e) {}
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.issue_number }},
              labels: ['blocked']
            });
