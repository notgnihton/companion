name: Auto-approve Copilot Agent PRs

# Triggers when Copilot coding agent opens/updates PRs (including drafts).
# Uses pull_request_target to get write permissions for PRs from copilot/ branches.
on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  approve-agent-work:
    # Run for PRs created by Copilot bot
    if: github.event.pull_request.user.login == 'Copilot' || github.event.pull_request.user.login == 'copilot-swe-agent[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Approve pending workflow runs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AGENT_PAT || secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            core.info(`Processing Copilot agent PR #${pr.number}: ${pr.title}`);
            core.info(`PR author: ${pr.user.login}, draft: ${pr.draft}`);

            // Approve any pending workflow runs on this PR's head SHA
            try {
              const runs = await github.rest.actions.listWorkflowRunsForRepo({
                owner,
                repo,
                head_sha: pr.head.sha,
                status: 'action_required',
              });

              for (const run of runs.data.workflow_runs) {
                core.info(`Approving workflow run ${run.id} (${run.name})...`);
                try {
                  await github.rest.actions.approveWorkflowRun({
                    owner,
                    repo,
                    run_id: run.id,
                  });
                  core.info(`  Approved run ${run.id}`);
                } catch (err) {
                  core.warning(`  Could not approve run ${run.id}: ${err.message}`);
                }
              }

              if (runs.data.total_count === 0) {
                core.info('No pending workflow runs to approve.');
              }
            } catch (err) {
              core.warning(`Failed to list workflow runs: ${err.message}`);
            }

      - name: Mark draft as ready for review
        if: github.event.pull_request.draft == true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AGENT_PAT || secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            core.info(`PR #${pr.number} is a draft. Converting to ready for review...`);

            // GraphQL is required â€” REST API cannot mark PRs ready for review
            const mutation = `mutation($id: ID!) {
              markPullRequestReadyForReview(input: { pullRequestId: $id }) {
                pullRequest { id number isDraft }
              }
            }`;

            try {
              const result = await github.graphql(mutation, { id: pr.node_id });
              core.info(`Marked PR #${pr.number} as ready for review`);
            } catch (err) {
              core.warning(`Could not mark ready: ${err.message}`);
            }

      - name: Add labels
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const labels = pr.labels.map(l => l.name);
            const toAdd = [];

            if (!labels.includes('agent-task')) toAdd.push('agent-task');
            if (!labels.includes('agent-automerge')) toAdd.push('agent-automerge');

            if (toAdd.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: toAdd,
              });
              core.info(`Added labels: ${toAdd.join(', ')}`);
            }

      - name: Approve PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AGENT_PAT || secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;

            try {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                event: 'APPROVE',
                body: 'Auto-approved: PR from copilot-swe-agent[bot].',
              });
              core.info(`Approved PR #${pr.number}`);
            } catch (err) {
              core.warning(`Could not approve PR: ${err.message}`);
            }

      - name: Merge PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AGENT_PAT || secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;

            // Wait a moment for the ready_for_review status to propagate
            await new Promise(r => setTimeout(r, 5000));

            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                merge_method: 'squash',
              });
              core.info(`Merged PR #${pr.number}`);
            } catch (err) {
              core.info(`Merge not ready yet: ${err.message}`);
              core.info('Will be handled by agent-pr-automation when ready.');
            }
