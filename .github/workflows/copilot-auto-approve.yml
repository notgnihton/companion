name: Auto-approve Agent PRs

# Triggers when any AI coding agent opens/updates PRs (including drafts).
# Handles Claude (Anthropic), Codex (OpenAI), and Copilot (GitHub) bots.
# Uses pull_request_target to get write permissions for PRs from agent branches.
on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  approve-agent-work:
    # Run for PRs created by any AI coding agent bot
    if: |
      github.event.pull_request.user.login == 'Copilot' ||
      github.event.pull_request.user.login == 'copilot-swe-agent[bot]' ||
      github.event.pull_request.user.login == 'Claude' ||
      github.event.pull_request.user.login == 'anthropic-code-agent[bot]' ||
      github.event.pull_request.user.login == 'Codex' ||
      github.event.pull_request.user.login == 'openai-code-agent[bot]' ||
      github.event.pull_request.user.login == 'chatgpt-codex-connector[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Approve pending workflow runs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AGENT_PAT || secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            core.info(`Processing agent PR #${pr.number}: ${pr.title}`);
            core.info(`PR author: ${pr.user.login}, draft: ${pr.draft}`);

            // Approve any pending workflow runs on this PR's head SHA
            try {
              const runs = await github.rest.actions.listWorkflowRunsForRepo({
                owner,
                repo,
                head_sha: pr.head.sha,
                status: 'action_required',
              });

              for (const run of runs.data.workflow_runs) {
                core.info(`Approving workflow run ${run.id} (${run.name})...`);
                try {
                  await github.rest.actions.approveWorkflowRun({
                    owner,
                    repo,
                    run_id: run.id,
                  });
                  core.info(`  Approved run ${run.id}`);
                } catch (err) {
                  core.warning(`  Could not approve run ${run.id}: ${err.message}`);
                }
              }

              if (runs.data.total_count === 0) {
                core.info('No pending workflow runs to approve.');
              }
            } catch (err) {
              core.warning(`Failed to list workflow runs: ${err.message}`);
            }

      - name: Add labels
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const labels = pr.labels.map(l => l.name);
            const toAdd = [];

            if (!labels.includes('agent-task')) toAdd.push('agent-task');
            if (!labels.includes('agent-automerge')) toAdd.push('agent-automerge');

            if (toAdd.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: toAdd,
              });
              core.info(`Added labels: ${toAdd.join(', ')}`);
            }

      - name: Approve PR
        if: github.event.pull_request.draft == false
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AGENT_PAT || secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;

            try {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                event: 'APPROVE',
                  body: `Auto-approved: PR from ${pr.user.login} agent.`,
              });
              core.info(`Approved PR #${pr.number}`);
            } catch (err) {
              core.warning(`Could not approve PR: ${err.message}`);
            }
