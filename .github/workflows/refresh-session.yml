name: Refresh Session Cookie

on:
  schedule:
    # Run every 3 days at 04:00 UTC
    - cron: '0 4 */3 * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  refresh:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: |
          npm i -D playwright@latest
          npx playwright install chromium --with-deps

      - name: Check and refresh session
        id: session
        env:
          GH_SESSION_COOKIE: ${{ secrets.GH_SESSION_COOKIE }}
        run: node .github/scripts/refresh-session-ci.mjs

      - name: Update secret if cookie changed
        if: steps.session.outputs.cookie_changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.AGENT_PAT }}
        run: |
          echo "${{ steps.session.outputs.cookie_value }}" | gh secret set GH_SESSION_COOKIE
          echo "âœ“ Secret updated with refreshed cookie"

      - name: Report status
        if: always()
        run: |
          if [ "${{ steps.session.outcome }}" = "success" ]; then
            echo "âœ“ Session valid â€” ${{ steps.session.outputs.days_left }} days remaining"
            echo "  Cookie changed: ${{ steps.session.outputs.cookie_changed }}"
          else
            echo "âœ— Session expired or invalid!"
            echo "  Run locally: node .github/scripts/refresh-session.mjs"
          fi

      - name: Create issue on session expiry
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.AGENT_PAT }}
        run: |
          # Only create if no open refresh issue exists
          EXISTING=$(gh issue list -R ${{ github.repository }} --label "session-refresh" --state open --json number -q '.[0].number')
          if [ -z "$EXISTING" ]; then
            gh issue create -R ${{ github.repository }} \
              --title "ðŸ”‘ GitHub session cookie expired â€” Claude assignments will fail" \
              --label "session-refresh" \
              --body "The \`GH_SESSION_COOKIE\` secret has expired. Claude cannot be assigned to issues until it's refreshed.

          **To fix (takes 30 seconds):**

          \`\`\`bash
          cd companion
          npx playwright install chromium  # first time only
          node .github/scripts/refresh-session.mjs
          \`\`\`

          This opens a browser â†’ log into GitHub â†’ press Enter â†’ done.

          _This issue was created automatically by the refresh-session workflow._"
          fi
